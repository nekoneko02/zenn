---
title: "AWS CDK 脱初心者・中級者に向けた第一歩"
emoji: "🐡"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["AWS","CDK","初心者"]
published: false
---
# 概要
CDK脱初心者に向けた、Tips集を書きました。

# 対象読者
以下の人を想定しています。
- CDKを勉強したい人
- とりあえずハンズオンして使ってみたけど、次にどうすれば良いかわからない人

# 環境構築~ハンズオンを最低一回やる
想定読者はやっている前提ですが、一応書いておきます。
[公式のハンズオン](https://docs.aws.amazon.com/ja_jp/cdk/v2/guide/getting_started.html)
# 基本的な概念を理解する
## CDK周りの用語を理解する。
よくある用語は以下の通りです：

|用語|説明|CDKとの関係|
|--|--|--|
|CDK|自分の好きなプログラミング言語で、AWSのリソースを定義できる仕組み（IaC）|-|
|Cloudformation|yaml形式で、AWSのリソースを定義できる仕組み（IaC）|CDKのコードは一度Cloudformationに変換されてからデプロイされる|
|SAM|サーバーレスアプリケーションのCloudformationを少し簡単に書ける仕組み|直接的な関係はない。ただし、SAMとCDKを連携させてローカルテストする方法もあるらしい|
|SDK|プログラムからAWSリソースを操作するためのライブラリ|名前が似ているだけで関係ない。IaCでもない。|

補足を入れると、Cloudformationで定義するリソースはAWSリソースと一対一に対応している。
- 例えばVPCを定義するCloudformationの中には、VPCとInternet Gatewayと"VPCとInternet Gatewayの紐づけ"という3つのリソースが定義される（他にもSubnet, Route Table, Route Tabelの紐づけなどなど）
- AWSのコンソールでの操作感とかなり乖離があり、Cloudformation特有の難しさがある

一方で、CDKにはもう少し便利な仕組みがある（詳細は次節）

## L2コンストラクタを使う
CDKには、L1, L2, L3コンストラクタの3種類がある。

詳しい説明は[こちらの記事](https://qiita.com/KbSota/items/be3b4063deea52815d50)などが参考になるが、ざっくりと以下のイメージ：
|コンストラクタ|説明|補足|
|--|--|--|
|L1|Cloudformationと同レベルで、AWSリソースを定義するコンストラクタ|`Cfnxxx`という名前。例：`CfnVpc`|
|L2|L1より高い抽象度でリソースを定義できるコンストラクタ。イメージは、コンソール上で操作する単位に近い。|名前にプレフィックスがない。例：`Vpc`|
|L3|L2よりさらに高い抽象度で、Lambda+API Gatewayといった典型パターンを定義できるコンストラクタ|例：`LambdaRestApi`, `ApplicationLoadBalancedEc2Service`|

そして、L2を使うのがおすすめである。なぜなら、
- L1は細かすぎて使いにくい（CDKを使うメリットがあまりなく、Cloudformationとほぼ同じである）
- L3は色々（勝手に）設定されるのでわかりにくく、やや柔軟性に欠ける。特に、勉強という意味でも、色々設定されるのは理解しづらい。
- 中間のL2がちょうどいい。コンソール操作と抽象度が近く、理解しやすい。

ちなみに、L2, L3は明確な命名規則がない（たぶん）
L2はコンソールでよく見るサービス名、L3はサービス名の組み合わせという感じである。また、L3は`aws_ecs_patterns`のようなモジュールでまとまっていることもある。

# 具体的な進め方
## "とりあえず動くコード"を書く
先述のL2コンストラクタを使ってリソースを定義したら、すぐにデプロイすることをお勧めする。
さらに言うと、
1. （作りたいリソースの）サンプルコードをググる
2. コピペする
3. デプロイする

簡単に理由を説明する：

AWS コンソールで操作する場合は、基本的にはわかりやすいので、初めから色々設定してデプロイすると思う。
たとえ設定ミスがあっても、すぐにエラー表示されるので、比較的簡単に修正してデプロイできる。

ただ、CDKの場合はそうではない。

最初のコンパイルでエラーになるなら良いが、デプロイしないとエラーが出ないことも多い。特に、デプロイに数分（ロールバックも数分）かかり、トライアンドエラーしているとあっという間に時間が過ぎてしまう（最悪の場合、挫折して終わる…）

そのため、一度"デプロイに成功する状態"をつくり、少しずつコードを修正するのが、効率的に進められると感じている。
ちなみに、デプロイ成功させる（=成功体験を得る）というのも、大きなメリットである。

また、以下のような流れも良い：
1. CDKでデプロイする
2. コンソールで設定変更する
3. CDKに反映する
4. CDKで再デプロイする
5. 所望の設定になっているか確認する

### デプロイしたリソースをいじる際の注意点
補足として、CDKでデプロイしたリソースをコンソールから変更する場合の注意点を説明する。
それは、CDK destroy（リソース削除）のときに失敗することがあることである。

色々依存関係があり、失敗するようである。
また、このとき、コマンドで`cdk deploy`, `cdk destory`をやり直しても（削除に失敗した状態のスタックがあるため）失敗する。

この場合は、コンソール上でリソースを削除→コンソール上でCloudformationのスタック削除という流れで解決できる（はず）。
## 公式リファレンスを見る
CDK関連のブログ記事は多いが、結局公式リファレンスを見るのが確実である。
https://docs.aws.amazon.com/cdk/api/v2/docs/aws-construct-library.html

前節を踏まえて、以下のような流れで実装を進めるとよい：
1. とりあえずサンプルコードを動かす
2. コンソール等を見ながら設定箇所を理解する
3. 公式リファレンスでどのパラメータを設定すれば良いか確認する
4. コードに反映する

※ちなみに、サンプルコードはブログ記事で探したほうが良いと思う

# 他にも試してみる！
## CDKを最小権限で利用する
個人開発や勉強でやるなら、広めの権限でもよい。
が、最小権限でやってみるというのも良い。

詳細は、以下の記事が参考になる：
https://dev.classmethod.jp/articles/cdk-minimum-deploy-policy/

## Amazon Q Developerを使う
最近ブームの生成AIサービスで、使わない手はない。とりあえず、vscodeの拡張機能を入れてみることを勧める。
https://docs.aws.amazon.com/ja_jp/amazonq/latest/qdeveloper-ug/getting-started-q-dev.html

無料枠があり、CDKコードを一から生成してもらうことも、既存のコードを修正してもらうことも可能で、結構便利。
ただし、一発で所望のコードが得られない場合も多いので、ある程度CDKを読む力も必要である。

# その他、参考文献
- [初心者がおさえておきたいAWS CDKのベストプラクティス 2024](https://speakerdeck.com/konokenj/cdk-best-practice-2024)